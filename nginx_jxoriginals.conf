##############################################################################
# NGINX Configuration Snippet for JxOriginals
#
# Add this to your NGINX server block for backend.jackpotx.net
# Location: /etc/nginx/sites-available/backend.jackpotx.net
##############################################################################

# JxOriginals Games Static Files and PHP Processing
location /JxOriginalGames/ {
    alias /var/www/html/backend.jackpotx.net/JxOriginalGames/;

    # Default index files
    index index.html index.php Server.php;

    # Try files in order
    try_files $uri $uri/ =404;

    # PHP processing for game servers
    location ~ \.php$ {
        # Security: Prevent direct access to PHP files in certain directories
        location ~ ^/JxOriginalGames/(PTWebSocket|arcade_server|mod)/ {
            deny all;
            return 404;
        }

        # PHP-FPM configuration
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index Server.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $request_filename;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;

        # Increase timeouts for game sessions
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;

        # Buffer settings
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
    }

    # Security: Block access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Security: Block access to sensitive files
    location ~ \.(sql|env|git|gitignore|md|txt|log)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Cache static game assets (images, CSS, JS)
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|otf|mp3|mp4|ogg|webm|wav)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # JSON configuration files - no cache
    location ~* \.json$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    }

    # CORS headers for game assets (if needed)
    add_header Access-Control-Allow-Origin "https://jackpotx.net" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
}

# WebSocket Proxy for JxOriginals Games
# Routes WebSocket connections to PTWebSocket servers
location /ws/ {
    # Proxy to local WebSocket server
    proxy_pass https://127.0.0.1:8443/;

    # WebSocket upgrade headers
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # Timeouts for long-lived WebSocket connections
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;

    # Buffer settings
    proxy_buffering off;
    proxy_request_buffering off;

    # WebSocket keep-alive
    proxy_socket_keepalive on;
    tcp_nodelay on;
}

# Alternative WebSocket endpoint (direct port access)
# This allows games to connect directly to wss://backend.jackpotx.net:8443
# Make sure port 8443 is open in firewall
# UFW: sudo ufw allow 8443/tcp

# Optional: Game analytics endpoint
location /api/jxoriginals/analytics {
    proxy_pass http://localhost:3001/api/jxoriginals/analytics;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # Log analytics separately
    access_log /var/log/nginx/jxoriginals-analytics.log;
}

# Optional: Health check endpoint for monitoring
location /api/jxoriginals/health {
    proxy_pass http://localhost:3001/api/jxoriginals/health;
    access_log off;
}

##############################################################################
# SSL Configuration (if not already configured)
##############################################################################

# listen 443 ssl http2;
# listen [::]:443 ssl http2;
#
# ssl_certificate /etc/letsencrypt/live/backend.jackpotx.net/fullchain.pem;
# ssl_certificate_key /etc/letsencrypt/live/backend.jackpotx.net/privkey.pem;
#
# ssl_protocols TLSv1.2 TLSv1.3;
# ssl_ciphers HIGH:!aNULL:!MD5;
# ssl_prefer_server_ciphers on;

##############################################################################
# Rate Limiting (Optional - prevent abuse)
##############################################################################

# Define rate limit zone (add this in http block, outside server block)
# limit_req_zone $binary_remote_addr zone=jxoriginals_games:10m rate=10r/s;
#
# Then use in location blocks:
# limit_req zone=jxoriginals_games burst=20 nodelay;

##############################################################################
# Logging Configuration
##############################################################################

# Custom log format for game requests
# log_format jxoriginals '$remote_addr - $remote_user [$time_local] '
#                        '"$request" $status $body_bytes_sent '
#                        '"$http_referer" "$http_user_agent" '
#                        'game="$arg_game_id" token="$arg_token"';
#
# access_log /var/log/nginx/jxoriginals-access.log jxoriginals;
# error_log /var/log/nginx/jxoriginals-error.log warn;
